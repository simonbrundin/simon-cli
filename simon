#!/bin/bash

# Get the directory of this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source converted scripts
source "$SCRIPT_DIR/scripts/setup.sh"
source "$SCRIPT_DIR/scripts/workflow.sh"
source "$SCRIPT_DIR/scripts/git.sh"
source "$SCRIPT_DIR/scripts/coding.sh"
source "$SCRIPT_DIR/scripts/talos.sh"
source "$SCRIPT_DIR/scripts/ai.sh"
source "$SCRIPT_DIR/scripts/install.sh"
source "$SCRIPT_DIR/scripts/config.sh"
source "$SCRIPT_DIR/scripts/pxe.sh"
source "$SCRIPT_DIR/scripts/ceph.sh"
source "$SCRIPT_DIR/scripts/kubernetes.sh"
source "$SCRIPT_DIR/scripts/update.sh"
source "$SCRIPT_DIR/scripts/unifi.sh"

# Source functions
source "$SCRIPT_DIR/functions.sh"

# Banner
banner="
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                        â•‘
â•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—    â•‘
â•‘    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘    â•‘
â•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘    â•‘
â•‘    â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘    â•‘
â•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â•‘
â•‘    â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•     â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•    â•‘
â•‘                                                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"

# Dynamically collect commands from defined functions
commands=()
for func in $(declare -F | awk '{print $3}' | grep '^main_' | grep -v '^main$'); do
    cmd=$(echo "$func" | sed 's/^main_//' | tr '_' ' ')
    commands+=("$cmd")
done

main() {
    echo -e "\033[34m$banner\033[0m"
    echo "The most personal CLI ever <3"
    echo "See commands - simon --help"

    # Add script-based commands dynamically? For now, hardcoded.
    # TODO: Add commands from scripts if they have main functions.

    selectedCommand=$(printf '%s\n' "${commands[@]}" | fzf | tr -d '\n')

    if [ -z "$selectedCommand" ]; then
        echo "âŒ Inget kommando valt"
        exit 1
    fi

    echo -e "\033[34mKÃ¶r kommando: \033[0m$selectedCommand"

    # Set arguments for subcommand parsing
    set -- $selectedCommand

    # Run the subcommand parsing logic
    case "$1" in
            docs) main_docs ;;
            ip) main_ip ;;
            vpn)
                case "$2" in
                    up) main_vpn_up ;;
                    status) main_vpn_status ;;
                    download) main_vpn_download ;;
                    down) main_vpn_down ;;
                    *) echo "Unknown vpn command: $2" ;;
                esac
                ;;
            new)
                case "$2" in
                    repo) shift 2; main_new_repo "$@" ;;
                    *) echo "Unknown new command: $2" ;;
                esac
                ;;
            disk) shift; main_disk "$@" ;;
            flash) main_flash ;;
            xfs) main_xfs ;;
            speed) main_speed ;;
            reboot) main_reboot ;;
            edit)
                case "$2" in
                    cron) main_edit_cron ;;
                    *) echo "Unknown edit command: $2" ;;
                esac
                ;;
            list)
                case "$2" in
                    cron) main_list_cron ;;
                    *) echo "Unknown list command: $2" ;;
                esac
                ;;
            kanata)
                case "$2" in
                    start) main_kanata_start ;;
                    restart) main_kanata_restart ;;
                    test) main_kanata_test ;;
                    *) echo "Unknown kanata command: $2" ;;
                esac
                ;;
            kubernetes)
                arg="$2"
                if [ -n "$3" ]; then arg="$arg $3"; fi
                case "$arg" in
                    "login certificate") main_kubernetes_login_certificate ;;
                    "login teleport") main_kubernetes_login_teleport ;;
                    "dashboard") main_kubernetes_dashboard ;;
                    "approve csr") main_kubernetes_approve_csr ;;
                    "delete pod") main_kubernetes_delete_pod ;;
                    "debug") shift 2; main_kubernetes_debug "$@" ;;
                    "remove finalizers") main_kubernetes_remove_finalizers ;;
                    "deleting") main_kubernetes_deleting ;;
                    "terminating") main_kubernetes_terminating ;;
                    "remove selected") main_kubernetes_remove_selected ;;
                    "longhorn test") main_kubernetes_longhorn_test ;;
                    "install argocd") main_kubernetes_install_argocd ;;
                    *) echo "Unknown kubernetes command: $arg" ;;
                esac
                ;;
            talos)
                arg="$2"
                if [ -n "$3" ]; then arg="$arg $3"; fi
                case "$arg" in
                    "dashboard") shift 2; main_talos_dashboard "$@" ;;
                    "upgrade") main_talos_upgrade ;;
                    "update config") shift 2; main_talos_update_config "$@" ;;
                    "health") main_talos_health ;;
                    "update kubeconfig") main_talos_update_kubeconfig ;;
                    "reboot all") main_talos_reboot_all ;;
                    *) echo "Unknown talos command: $arg" ;;
                esac
                ;;
            bootstrap)
                case "$2" in
                    mac) main_bootstrap_mac ;;
                    *) echo "Unknown bootstrap command: $2" ;;
                esac
                ;;
            setup)
                case "$2" in
                    argocd) main_setup_argocd ;;
                    pxe) main_setup_pxe ;;
                    *) echo "Unknown setup command: $2" ;;
                esac
                ;;
            install) shift; main_install "$@" ;;
            i) shift; main_i "$@" ;;
            uninstall) shift; main_uninstall "$@" ;;
            chezmoi)
                case "$2 $3" in
                    "convert symlink") main_chezmoi_convert_symlink ;;
                    *) echo "Unknown chezmoi command: $2 $3" ;;
                esac
                ;;
            config) shift; main_config "$@" ;;
            c) shift; main_c "$@" ;;
            source) shift; main_source "$@" ;;
            s) shift; main_s "$@" ;;
            pxe)
                case "$2 $3" in
                    "debug dhcp") main_pxe_debug_dhcp ;;
                    "debug tftp") main_pxe_debug_tftp ;;
                    *) echo "Unknown pxe command: $2 $3" ;;
                esac
                ;;
            backup)
                case "$2" in
                    pxe) main_backup_pxe ;;
                    *) echo "Unknown backup command: $2" ;;
                esac
                ;;
            dev) main_dev ;;
            devpod)
                case "$2" in
                    delete) main_devpod_delete ;;
                    *) echo "Unknown devpod command: $2" ;;
                esac
                ;;
            login)
                case "$2" in
                    vault) main_login_vault ;;
                    *) echo "Unknown login command: $2" ;;
                esac
                ;;
            test) main_test ;;
            commit) main_commit ;;
            clone) shift; main_clone "$@" ;;
            ci) shift; main_ci "$@" ;;
            ai)
                if [ -z "$2" ]; then
                    main_ai
                else
                    case "$2 $3" in
                        "change agent") main_ai_change_agent ;;
                        "set agent") main_ai_set_agent ;;
                        *) echo "Unknown ai command: $2 $3" ;;
                    esac
                fi
                ;;
            ceph)
                case "$2" in
                    status) main_ceph_status ;;
                    cluster) main_ceph_cluster ;;
                    delete) main_ceph_delete ;;
                    *) echo "Unknown ceph command: $2" ;;
                esac
                ;;
            update)
                case "$2" in
                    agentos) main_update_agentos "$3" ;;
                    *) echo "Unknown update command: $2" ;;
                esac
                ;;
            *) echo "Unknown command: $1" ;;
        esac
}

# Subcommands

main_docs() {
    options=(
        "Karabiner.ts"
        "Nushell"
        "Yazi"
        "Talos"
        "OpenCode"
    )

    choice=$(fzfSelect "${options[@]}")

    case $choice in
        "Karabiner.ts") xdg-open https://karabiner.ts.evanliu.dev/ ;;
        "Nushell") xdg-open https://www.nushell.sh/book/ ;;
        "Talos") xdg-open https://www.talos.dev/v1.10/ ;;
        "OpenCode") xdg-open https://opencode.ai/docs/ ;;
        "Yazi") xdg-open https://yazi-rs.github.io/docs/installation ;;
    esac
}

main_ip() {
    ips=$(ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '127.0.0.1')
    first_ip=$(echo "$ips" | head -1)
    rest_ips=$(echo "$ips" | tail -n +2)
    echo ""
    echo "  â”Œâ”€[$first_ip]â”€â”"
    echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""
    echo "$rest_ips"
}

main_vpn_up() {
    echo -e "\033[34mğŸ” Ansluter till UniFi VPN...\033[0m"

    if command -v networksetup >/dev/null 2>&1 && networksetup -showpppoestatus "UniFi Teleport" >/dev/null 2>&1; then
        echo "FÃ¶rsÃ¶ker med UniFi Teleport..."
        networksetup -connectpppoeservice "UniFi Teleport" 2>&1

        local status
        for i in {1..10}; do
            status=$(networksetup -showpppoestatus "UniFi Teleport" 2>/dev/null | tr -d '\n')
            if [ "$status" = "connected" ]; then
                echo -e "\033[32mâœ… UniFi Teleport ansluten!\033[0m"
                return 0
            fi
            sleep 1
            echo "."
        done
        echo "Teleport anslÃ¶t inte. FÃ¶rsÃ¶ker WireGuard..."
    fi

    local WIREGUARD_DIR="$HOME/.wireguard"
    local WIREGUARD_CONFIG="$WIREGUARD_DIR/unifi.conf"

    if ! command -v wg-quick >/dev/null 2>&1; then
        echo -e "\033[31mâŒ WireGuard Ã¤r inte installerat\033[0m"
        return 1
    fi

    if [ ! -f "$WIREGUARD_CONFIG" ]; then
        echo -e "\033[31mâŒ Ingen WireGuard-config hittad\033[0m"
        echo "Spara config som ~/.wireguard/unifi.conf"
        return 1
    fi

    echo "Startar WireGuard..."
    sudo wg-quick up unifi 2>&1

    if [ $? -eq 0 ]; then
        echo -e "\033[32mâœ… WireGuard ansluten!\033[0m"
        echo ""
        echo "Testa anslutning:"
        echo "  ping 10.10.10.2"
    else
        echo -e "\033[31mâŒ Kunde inte ansluta till WireGuard\033[0m"
    fi
}

main_new_repo() {
    name="$1"
    if [ -z "$name" ]; then
        echo "Usage: simon new repo <name>"
        return
    fi
    repo_path="$HOME/repos/$name"

    mkdir -p "$repo_path"
    cd "$repo_path"

    git init
    git checkout -b main

    echo "# $name" > README.md

    git add .
    git commit -m "Initial commit"

    gh repo create "$name" --public --remote=origin --source="$repo_path" --push

    git push -u origin main

    echo "Repo $name skapat i $repo_path och pushat till GitHub!"
}

main_vpn_down() {
    echo -e "\033[34mğŸ”’ Kopplar frÃ¥n WireGuard...\033[0m"
    sudo wg-quick down unifi 2>&1 || echo "Ingen WireGuard-anslutning aktiv"
    echo -e "\033[32mâœ… WireGuard frÃ¥nkopplad\033[0m"
}

main_vpn_status() {
    echo -e "\033[34mğŸ“¡ WireGuard-status:\033[0m"
    wg 2>&1 || echo "Ingen WireGuard-interface aktiv"
}

main_vpn_download() {
    local unifi_controller="https://10.1.1.1"
    local unifi_api_key

    mkdir -p ~/.op
    chmod 700 ~/.op
    op signin --raw > ~/.op/session 2>/dev/null

    unifi_api_key=$(op read "op://Private/Ubiquiti/API-key local" 2>/dev/null)

    if [ -z "$unifi_api_key" ]; then
        echo -e "\033[31mâŒ Kunde inte hÃ¤mta API-nyckel frÃ¥n 1Password\033[0m"
        rm -f ~/.op/session
        return 1
    fi

    echo -e "\033[34mğŸŒ HÃ¤mtar WireGuard-klienter frÃ¥n UniFi...\033[0m"

    local response
    response=$(curl -s -k -X GET "${unifi_controller}/proxy/network/api/s/default/vpn/wireguardclients" \
        -H "X-API-Key: $unifi_api_key" \
        -H "Accept: application/json" 2>/dev/null)

    if ! echo "$response" | jq -e '.data' >/dev/null 2>&1; then
        echo -e "\033[31mâŒ Kunde inte hÃ¤mta WireGuard-klienter\033[0m"
        echo "GÃ¥ till https://10.1.1.1 och skapa en WireGuard-klient manuellt"
        rm -f ~/.op/session
        return 1
    fi

    local clients
    clients=$(echo "$response" | jq -r '.data[] | "\(.name) - \(.enabled)"' 2>/dev/null)

    if [ -z "$clients" ]; then
        echo "Inga WireGuard-klienter hittades. Skapa en i UniFi Controller:"
        echo "  Settings â†’ VPN â†’ WireGuard â†’ Add Client"
        rm -f ~/.op/session
        return 1
    fi

    echo ""
    echo "TillgÃ¤ngliga WireGuard-klienter:"
    echo "$clients"
    echo ""
    echo "FÃ¶r att ladda ner en specifik config, gÃ¥ till:"
    echo "  ${unifi_controller}/proxy/network/api/s/default/vpn/wireguardclients/<client-id>/download"

    rm -f ~/.op/session
}

main_disk() {
    mappnamn="${1:-$HOME}"
    gdu-go "$mappnamn"
}

main_flash() {
    ssh pxe -t "/home/linuxbrew/.linuxbrew/bin/nu ~/infrastructure/pxe/flash.nu"
}

main_xfs() {
    ssh pxe -t "/home/linuxbrew/.linuxbrew/bin/nu /home/simon/infrastructure/pxe/xfs.nu"
}

main_speed() {
    speedtest
}

main_edit_cron() {
    crontab -e
}

main_list_cron() {
    crontab -l
}

main_kanata_start() {
    systemctl --user start kanata
}

main_kanata_restart() {
    systemctl --user restart kanata
}

main_kanata_test() {
    cat /home/simon/repos/dotfiles/kanata/.config/kanata/kanata.kbd | cb
    xdg-open "https://jtroo.github.io/"
}

show_help() {
    echo "Available commands:"
    echo "  docs              Open documentation links"
    echo "  ip                Show local IP addresses"
    echo "  vpn up            Connect to VPN"
    echo "  new repo <name>   Create new GitHub repo"
    echo "  vpn down          Disconnect VPN"
    echo "  disk [path]       Disk usage analysis"
    echo "  flash             Flash device via PXE"
    echo "  xfs               Prepare disk for Longhorn"
    echo "  speed             Speed test"
    echo "  edit cron         Edit cron jobs"
    echo "  list cron         List cron jobs"
    echo "  kanata start      Start Kanata"
    echo "  kanata restart    Restart Kanata"
    echo "  kanata test       Test Kanata"
    echo ""
    echo "Kubernetes commands:"
    echo "  kubernetes login certificate"
    echo "  kubernetes login teleport"
    echo "  kubernetes dashboard"
    echo "  kubernetes approve csr"
    echo "  kubernetes delete pod"
    echo "  kubernetes debug [name]"
    echo "  kubernetes remove finalizers"
    echo "  kubernetes deleting"
    echo "  kubernetes terminating"
    echo "  kubernetes remove selected"
    echo "  kubernetes longhorn test"
    echo "  kubernetes install argocd"
    echo ""
    echo "Talos commands:"
    echo "  talos dashboard"
    echo "  talos upgrade"
    echo "  talos update config [nodnamn]"
    echo "  talos health"
    echo "  talos update kubeconfig"
    echo "  talos reboot all"
    echo ""
    echo "Setup commands:"
    echo "  bootstrap mac"
    echo "  setup argocd"
    echo ""
    echo "Install commands:"
    echo "  install <package>"
    echo "  i <package>"
    echo "  uninstall <package>"
    echo ""
    echo "Config commands:"
    echo "  chezmoi convert symlink"
    echo "  config [tool]"
    echo "  c [tool]"
    echo "  source [tool]"
    echo "  s [tool]"
    echo ""
    echo "PXE commands:"
    echo "  pxe debug dhcp"
    echo "  pxe debug tftp"
    echo "  backup pxe"
    echo "  setup pxe"
    echo ""
    echo "Coding commands:"
    echo "  dev"
    echo "  devpod delete"
    echo "  login vault"
    echo "  test"
    echo "  commit"
    echo ""
    echo "Git commands:"
    echo "  clone <name>"
    echo ""
    echo "Workflow commands:"
    echo "  ci <project> [--push] [--multi] [--tag <tag>]"
    echo ""
    echo "AI commands:"
    echo "  ai"
    echo "  ai change agent"
    echo "  ai set agent"
    echo ""
    echo "Ceph commands:"
    echo "  ceph status"
    echo "  ceph cluster"
    echo "  ceph delete"
    echo ""
    echo "Update commands:"
    echo "  update agentos [--no-projects]  Update Agent OS and optionally projects"
}

# Run logic if executed or sourced
if [ "$1" = "--help" ]; then
    show_help
    exit 0
elif [ $# -eq 0 ]; then
    main
else
    # Parse subcommands
    case "$1" in
            docs) main_docs ;;
            ip) main_ip ;;
            vpn)
                case "$2" in
                    up) main_vpn_up ;;
                    status) main_vpn_status ;;
                    download) main_vpn_download ;;
                    down) main_vpn_down ;;
                    *) echo "Unknown vpn command: $2" ;;
                esac
                ;;
            new)
                case "$2" in
                    repo) shift 2; main_new_repo "$@" ;;
                    *) echo "Unknown new command: $2" ;;
                esac
                ;;
            disk) shift; main_disk "$@" ;;
            flash) main_flash ;;
            xfs) main_xfs ;;
            speed) main_speed ;;
            reboot) main_reboot ;;
            edit)
                case "$2" in
                    cron) main_edit_cron ;;
                    *) echo "Unknown edit command: $2" ;;
                esac
                ;;
            list)
                case "$2" in
                    cron) main_list_cron ;;
                    *) echo "Unknown list command: $2" ;;
                esac
                ;;
            kanata)
                case "$2" in
                    start) main_kanata_start ;;
                    restart) main_kanata_restart ;;
                    test) main_kanata_test ;;
                    *) echo "Unknown kanata command: $2" ;;
                esac
                ;;
            kubernetes)
                arg="$2"
                if [ -n "$3" ]; then arg="$arg $3"; fi
                case "$arg" in
                    "login certificate") main_kubernetes_login_certificate ;;
                    "login teleport") main_kubernetes_login_teleport ;;
                    "dashboard") main_kubernetes_dashboard ;;
                    "approve csr") main_kubernetes_approve_csr ;;
                    "delete pod") main_kubernetes_delete_pod ;;
                    "debug") shift 2; main_kubernetes_debug "$@" ;;
                    "remove finalizers") main_kubernetes_remove_finalizers ;;
                    "deleting") main_kubernetes_deleting ;;
                    "terminating") main_kubernetes_terminating ;;
                    "remove selected") main_kubernetes_remove_selected ;;
                    "longhorn test") main_kubernetes_longhorn_test ;;
                    "install argocd") main_kubernetes_install_argocd ;;
                    *) echo "Unknown kubernetes command: $arg" ;;
                esac
                ;;
            talos)
                arg="$2"
                if [ -n "$3" ]; then arg="$arg $3"; fi
                case "$arg" in
                    "dashboard") shift 2; main_talos_dashboard "$@" ;;
                    "upgrade") main_talos_upgrade ;;
                    "update config") shift 2; main_talos_update_config "$@" ;;
                    "health") main_talos_health ;;
                    "update kubeconfig") main_talos_update_kubeconfig ;;
                    "reboot all") main_talos_reboot_all ;;
                    *) echo "Unknown talos command: $arg" ;;
                esac
                ;;
            bootstrap)
                case "$2" in
                    mac) main_bootstrap_mac ;;
                    *) echo "Unknown bootstrap command: $2" ;;
                esac
                ;;
            setup)
                case "$2" in
                    argocd) main_setup_argocd ;;
                    pxe) main_setup_pxe ;;
                    *) echo "Unknown setup command: $2" ;;
                esac
                ;;
            install) shift; main_install "$@" ;;
            i) shift; main_i "$@" ;;
            uninstall) shift; main_uninstall "$@" ;;
            chezmoi)
                case "$2 $3" in
                    "convert symlink") main_chezmoi_convert_symlink ;;
                    *) echo "Unknown chezmoi command: $2 $3" ;;
                esac
                ;;
            config) shift; main_config "$@" ;;
            c) shift; main_c "$@" ;;
            source) shift; main_source "$@" ;;
            s) shift; main_s "$@" ;;
            pxe)
                case "$2 $3" in
                    "debug dhcp") main_pxe_debug_dhcp ;;
                    "debug tftp") main_pxe_debug_tftp ;;
                    *) echo "Unknown pxe command: $2 $3" ;;
                esac
                ;;
            backup)
                case "$2" in
                    pxe) main_backup_pxe ;;
                    *) echo "Unknown backup command: $2" ;;
                esac
                ;;
            dev) main_dev ;;
            devpod)
                case "$2" in
                    delete) main_devpod_delete ;;
                    *) echo "Unknown devpod command: $2" ;;
                esac
                ;;
            login)
                case "$2" in
                    vault) main_login_vault ;;
                    *) echo "Unknown login command: $2" ;;
                esac
                ;;
            test) main_test ;;
            commit) main_commit ;;
            clone) shift; main_clone "$@" ;;
            ci) shift; main_ci "$@" ;;
            ai)
                if [ -z "$2" ]; then
                    main_ai
                else
                    case "$2 $3" in
                        "change agent") main_ai_change_agent ;;
                        "set agent") main_ai_set_agent ;;
                        *) echo "Unknown ai command: $2 $3" ;;
                    esac
                fi
                ;;
            ceph)
                case "$2" in
                    status) main_ceph_status ;;
                    cluster) main_ceph_cluster ;;
                    delete) main_ceph_delete ;;
                    *) echo "Unknown ceph command: $2" ;;
                esac
                ;;
            update)
                case "$2" in
                    agentos) main_update_agentos "$3" ;;
                    *) echo "Unknown update command: $2" ;;
                esac
                ;;
            *) echo "Unknown command: $1" ;;
        esac
fi